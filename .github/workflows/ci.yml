name: CI

on:
  pull_request:
    branches: [main]
  push:
    branches: [main]

env:
  CARGO_TERM_COLOR: always

jobs:
  # TEMPORARY: Debug job only - find out why virt-customize hangs on BuildJet
  # All other jobs disabled until we fix the root cause

  debug-virt-customize:
    name: Debug virt-customize
    runs-on: buildjet-32vcpu-ubuntu-2204
    steps:
      - uses: actions/checkout@v4
        with:
          path: fcvm
      - uses: actions/checkout@v4
        with:
          repository: ejc3/fuse-backend-rs
          ref: master
          path: fuse-backend-rs
      - uses: actions/checkout@v4
        with:
          repository: ejc3/fuser
          ref: master
          path: fuser

      - name: System info
        run: |
          echo "=== System Info ==="
          uname -a
          cat /etc/os-release
          echo ""
          echo "=== CPU ==="
          lscpu | head -20
          echo ""
          echo "=== Memory ==="
          free -h
          echo ""
          echo "=== Disk ==="
          df -h

      - name: Check KVM
        run: |
          echo "=== KVM device ==="
          ls -la /dev/kvm || echo "No /dev/kvm"
          echo ""
          echo "=== KVM modules ==="
          lsmod | grep kvm || echo "No KVM modules loaded"
          echo ""
          echo "=== CPU virtualization flags ==="
          grep -E "(vmx|svm)" /proc/cpuinfo | head -1 || echo "No VMX/SVM"
          echo ""
          echo "=== Set KVM permissions ==="
          sudo chmod 666 /dev/kvm
          ls -la /dev/kvm

      - name: Check libguestfs/virt-customize
        run: |
          echo "=== Check if virt-customize is available ==="
          which virt-customize || echo "virt-customize not in PATH"
          dpkg -l | grep -E "(libguestfs|guestfs)" || echo "No libguestfs packages"
          echo ""
          echo "=== Install libguestfs-tools ==="
          sudo apt-get update
          sudo apt-get install -y libguestfs-tools
          echo ""
          echo "=== virt-customize version ==="
          virt-customize --version
          echo ""
          echo "=== libguestfs test ==="
          # This tests if libguestfs can launch its appliance
          echo "Running libguestfs-test-tool (may take a minute)..."
          timeout 120 sudo libguestfs-test-tool 2>&1 | tail -50 || echo "libguestfs-test-tool timed out or failed"

      - name: Setup btrfs
        run: |
          echo "=== Creating btrfs loopback ==="
          sudo truncate -s 20G /var/fcvm-btrfs.img
          sudo mkfs.btrfs /var/fcvm-btrfs.img
          sudo mkdir -p /mnt/fcvm-btrfs
          sudo mount -o loop /var/fcvm-btrfs.img /mnt/fcvm-btrfs
          sudo mkdir -p /mnt/fcvm-btrfs/{kernels,rootfs,state,snapshots,vm-disks,cache}
          sudo chown -R $(id -un):$(id -gn) /mnt/fcvm-btrfs
          ls -la /mnt/fcvm-btrfs/

      - name: Download kernel
        run: |
          echo "=== Downloading Firecracker kernel ==="
          curl -sL "https://s3.amazonaws.com/spec.ccfc.min/firecracker-ci/v1.11/x86_64/vmlinux-5.10.225" \
            -o /mnt/fcvm-btrfs/kernels/vmlinux.bin
          ls -la /mnt/fcvm-btrfs/kernels/

      - name: Download Ubuntu cloud image
        run: |
          echo "=== Downloading Ubuntu cloud image ==="
          curl -L "https://cloud-images.ubuntu.com/releases/24.04/release/ubuntu-24.04-server-cloudimg-amd64.img" \
            -o /mnt/fcvm-btrfs/cache/ubuntu-24.04-amd64.img
          ls -la /mnt/fcvm-btrfs/cache/

      - name: Test virt-customize directly (with timeout)
        run: |
          echo "=== Testing virt-customize directly ==="
          echo "Creating test copy of cloud image..."
          cp /mnt/fcvm-btrfs/cache/ubuntu-24.04-amd64.img /tmp/test-image.img

          echo ""
          echo "=== Running virt-customize with verbose output ==="
          echo "Start time: $(date)"

          # Run with timeout and capture all output
          timeout 180 sudo virt-customize \
            --add /tmp/test-image.img \
            --run-command "echo 'Hello from virt-customize'" \
            --verbose \
            2>&1 || {
              echo ""
              echo "=== virt-customize failed or timed out ==="
              echo "Exit code: $?"
              echo "End time: $(date)"
            }

          echo ""
          echo "=== virt-customize completed ==="
          echo "End time: $(date)"

      - name: Check what processes are running during virt-customize
        if: failure()
        run: |
          echo "=== Running processes ==="
          ps aux | grep -E "(qemu|libvirt|guestfs)" || echo "No relevant processes"
          echo ""
          echo "=== dmesg (last 50 lines) ==="
          sudo dmesg | tail -50
