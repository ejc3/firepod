name: CI

on:
  pull_request:
    branches: [main]
  push:
    branches: [main]

env:
  CARGO_TERM_COLOR: always

jobs:
  # Lint + Build + Native Tests - compile once, run all
  build-and-test:
    name: Build & Test
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          path: fcvm
      - uses: actions/checkout@v4
        with:
          repository: ejc3/fuse-backend-rs
          ref: master
          path: fuse-backend-rs
      - uses: actions/checkout@v4
        with:
          repository: ejc3/fuser
          ref: master
          path: fuser
      - uses: dtolnay/rust-toolchain@stable
        with:
          components: clippy, rustfmt
      - uses: Swatinem/rust-cache@v2
        with:
          workspaces: fcvm
      - name: Install cargo-machete
        run: cargo install cargo-machete
      - name: Check formatting
        working-directory: fcvm
        run: cargo fmt --all -- --check
      - name: Clippy
        working-directory: fcvm
        run: cargo clippy --all-targets --all-features -- -D warnings
      - name: Check unused dependencies
        working-directory: fcvm
        run: cargo machete
      - name: Build
        working-directory: fcvm
        run: cargo build --release --all-targets
      - name: Unit tests
        working-directory: fcvm
        run: cargo test --release --lib --all
      - name: CLI tests
        working-directory: fcvm
        run: cargo test --release --test test_cli_parsing --test test_state_manager
      - name: FUSE integration tests (root)
        working-directory: fcvm
        run: sudo -E env "PATH=$PATH" cargo test --release -p fuse-pipe --test integration_root -- --test-threads=1

  # Container FUSE tests - build container once, run all FUSE tests
  fuse-tests:
    name: FUSE Tests
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          path: fcvm
      - uses: actions/checkout@v4
        with:
          repository: ejc3/fuse-backend-rs
          ref: master
          path: fuse-backend-rs
      - uses: actions/checkout@v4
        with:
          repository: ejc3/fuser
          ref: master
          path: fuser
      - name: Run all FUSE tests (container)
        working-directory: fcvm
        run: |
          export FUSE_BACKEND_RS=${{ github.workspace }}/fuse-backend-rs
          export FUSER=${{ github.workspace }}/fuser
          export CONTAINER_ARCH=x86_64
          # Build container once, run all tests sequentially
          make container-test

  # POSIX compliance - separate because it's slow (8789 tests)
  posix-compliance:
    name: POSIX Compliance
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          path: fcvm
      - uses: actions/checkout@v4
        with:
          repository: ejc3/fuse-backend-rs
          ref: master
          path: fuse-backend-rs
      - uses: actions/checkout@v4
        with:
          repository: ejc3/fuser
          ref: master
          path: fuser
      - name: Run pjdfstest (container)
        working-directory: fcvm
        run: |
          export FUSE_BACKEND_RS=${{ github.workspace }}/fuse-backend-rs
          export FUSER=${{ github.workspace }}/fuser
          export CONTAINER_ARCH=x86_64
          make container-test-pjdfstest

  # VM tests - all on same runner, compile once
  vm-tests:
    name: VM Tests
    runs-on: buildjet-32vcpu-ubuntu-2204
    steps:
      - uses: actions/checkout@v4
        with:
          path: fcvm
      - uses: actions/checkout@v4
        with:
          repository: ejc3/fuse-backend-rs
          ref: master
          path: fuse-backend-rs
      - uses: actions/checkout@v4
        with:
          repository: ejc3/fuser
          ref: master
          path: fuser
      - name: Setup KVM permissions
        run: sudo chmod 666 /dev/kvm
      - name: Setup NBD module
        run: sudo modprobe nbd max_part=8
      - name: Setup network namespace directory
        run: sudo mkdir -p /var/run/netns
      - name: Setup iptables for VM networking
        run: |
          sudo iptables -P FORWARD ACCEPT
          sudo iptables -t nat -A POSTROUTING -s 172.30.0.0/16 -o eth0 -j MASQUERADE || true
      - name: Setup userfaultfd for snapshot cloning
        run: |
          if [ ! -e /dev/userfaultfd ]; then
            sudo mknod /dev/userfaultfd c 10 126
          fi
          sudo chmod 666 /dev/userfaultfd
          sudo sysctl -w vm.unprivileged_userfaultfd=1
      - name: Run all VM tests
        working-directory: fcvm
        run: |
          export FUSE_BACKEND_RS=${{ github.workspace }}/fuse-backend-rs
          export FUSER=${{ github.workspace }}/fuser
          export CONTAINER_ARCH=x86_64
          # Build once, run all VM tests sequentially
          make container-test-vm
