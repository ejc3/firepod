name: CI

on:
  pull_request:
    branches: [main]
  push:
    branches: [main]

env:
  CARGO_TERM_COLOR: always

jobs:
  # TEMPORARY: Debug job - run the ACTUAL fcvm rootfs creation like the real test does
  # All other jobs disabled until we fix the root cause

  debug-fcvm-rootfs:
    name: Debug fcvm rootfs creation
    runs-on: buildjet-32vcpu-ubuntu-2204
    steps:
      - uses: actions/checkout@v4
        with:
          path: fcvm
      - uses: actions/checkout@v4
        with:
          repository: ejc3/fuse-backend-rs
          ref: master
          path: fuse-backend-rs
      - uses: actions/checkout@v4
        with:
          repository: ejc3/fuser
          ref: master
          path: fuser

      - name: Setup KVM permissions
        run: sudo chmod 666 /dev/kvm

      - name: Setup NBD module
        run: |
          sudo modprobe nbd max_part=8
          ls -la /dev/nbd* | head -5

      - name: Setup btrfs
        run: |
          sudo truncate -s 20G /var/fcvm-btrfs.img
          sudo mkfs.btrfs /var/fcvm-btrfs.img
          sudo mkdir -p /mnt/fcvm-btrfs
          sudo mount -o loop /var/fcvm-btrfs.img /mnt/fcvm-btrfs
          sudo mkdir -p /mnt/fcvm-btrfs/{kernels,rootfs,state,snapshots,vm-disks,cache}
          sudo chown -R $(id -un):$(id -gn) /mnt/fcvm-btrfs

      - name: Download kernel
        run: |
          curl -sL "https://s3.amazonaws.com/spec.ccfc.min/firecracker-ci/v1.11/x86_64/vmlinux-5.10.225" \
            -o /mnt/fcvm-btrfs/kernels/vmlinux.bin

      - name: Build container image
        working-directory: fcvm
        run: |
          echo "=== Building test container ==="
          sudo podman build -t fcvm-test -f Containerfile --build-arg ARCH=x86_64 .

      - name: Run ACTUAL fcvm rootfs creation inside container
        working-directory: fcvm
        timeout-minutes: 10
        run: |
          echo "=== Running ACTUAL fcvm to trigger rootfs creation ==="
          echo "This is what the real test does"

          # Run with RUST_LOG to see all the debug output
          sudo podman run --rm --privileged \
            -v .:/workspace/fcvm \
            -v ${{ github.workspace }}/fuse-backend-rs:/workspace/fuse-backend-rs \
            -v ${{ github.workspace }}/fuser:/workspace/fuser \
            --device /dev/kvm \
            --device /dev/fuse \
            --device /dev/nbd0 \
            -v /mnt/fcvm-btrfs:/mnt/fcvm-btrfs \
            --network host \
            -e RUST_LOG=debug \
            fcvm-test \
            bash -c '
              set -x
              echo "=== Building fcvm ==="
              cd /workspace/fcvm
              cargo build --release 2>&1 | tail -20

              echo ""
              echo "=== Starting fcvm (this triggers rootfs creation) ==="
              echo "Start time: $(date)"

              # Run fcvm with a timeout - it will fail to become healthy but
              # we can see if rootfs creation succeeds
              timeout 300 ./target/release/fcvm podman run \
                --name debug-test \
                --network bridged \
                nginx:alpine \
                2>&1 || {
                  echo ""
                  echo "=== fcvm exited (expected - timeout or error) ==="
                  echo "Exit code: $?"
                  echo "End time: $(date)"
                }

              echo ""
              echo "=== Check if rootfs was created ==="
              ls -la /mnt/fcvm-btrfs/rootfs/ || true
              ls -la /mnt/fcvm-btrfs/cache/ || true
            '

      - name: Check what happened
        if: always()
        run: |
          echo "=== Final state ==="
          ls -la /mnt/fcvm-btrfs/rootfs/ || true
          ls -la /mnt/fcvm-btrfs/cache/ || true
          echo ""
          echo "=== Host dmesg ==="
          sudo dmesg | tail -30
