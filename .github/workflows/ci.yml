name: CI

on:
  pull_request:
    branches: [main]
  push:
    branches: [main]

env:
  CARGO_TERM_COLOR: always

jobs:
  # TEMPORARY: Debug job - run virt-customize INSIDE container like we do locally
  # All other jobs disabled until we fix the root cause

  debug-virt-customize-in-container:
    name: Debug virt-customize in container
    runs-on: buildjet-32vcpu-ubuntu-2204
    steps:
      - uses: actions/checkout@v4
        with:
          path: fcvm
      - uses: actions/checkout@v4
        with:
          repository: ejc3/fuse-backend-rs
          ref: master
          path: fuse-backend-rs
      - uses: actions/checkout@v4
        with:
          repository: ejc3/fuser
          ref: master
          path: fuser

      - name: Setup KVM permissions
        run: sudo chmod 666 /dev/kvm

      - name: Setup NBD module
        run: |
          sudo modprobe nbd max_part=8
          ls -la /dev/nbd* | head -5

      - name: Setup btrfs
        run: |
          echo "=== Creating btrfs loopback ==="
          sudo truncate -s 20G /var/fcvm-btrfs.img
          sudo mkfs.btrfs /var/fcvm-btrfs.img
          sudo mkdir -p /mnt/fcvm-btrfs
          sudo mount -o loop /var/fcvm-btrfs.img /mnt/fcvm-btrfs
          sudo mkdir -p /mnt/fcvm-btrfs/{kernels,rootfs,state,snapshots,vm-disks,cache}
          sudo chown -R $(id -un):$(id -gn) /mnt/fcvm-btrfs
          ls -la /mnt/fcvm-btrfs/

      - name: Download kernel
        run: |
          curl -sL "https://s3.amazonaws.com/spec.ccfc.min/firecracker-ci/v1.11/x86_64/vmlinux-5.10.225" \
            -o /mnt/fcvm-btrfs/kernels/vmlinux.bin

      - name: Download Ubuntu cloud image
        run: |
          curl -L "https://cloud-images.ubuntu.com/releases/24.04/release/ubuntu-24.04-server-cloudimg-amd64.img" \
            -o /mnt/fcvm-btrfs/cache/ubuntu-24.04-amd64.img
          ls -la /mnt/fcvm-btrfs/cache/

      - name: Build container image
        working-directory: fcvm
        run: |
          echo "=== Building test container ==="
          sudo podman build -t fcvm-test -f Containerfile --build-arg ARCH=x86_64 .

      - name: Test virt-customize INSIDE container
        working-directory: fcvm
        run: |
          echo "=== Testing virt-customize INSIDE container (matching local setup) ==="

          # This matches CONTAINER_RUN_FCVM from Makefile
          sudo podman run --rm --privileged \
            -v .:/workspace/fcvm \
            -v ${{ github.workspace }}/fuse-backend-rs:/workspace/fuse-backend-rs \
            -v ${{ github.workspace }}/fuser:/workspace/fuser \
            --device /dev/kvm \
            --device /dev/fuse \
            --device /dev/nbd0 \
            -v /mnt/fcvm-btrfs:/mnt/fcvm-btrfs \
            --network host \
            fcvm-test \
            bash -c '
              set -x
              echo "=== Inside container ==="
              echo "User: $(whoami)"
              echo "Kernel: $(uname -r)"

              echo ""
              echo "=== Check KVM ==="
              ls -la /dev/kvm || echo "No /dev/kvm"

              echo ""
              echo "=== Check virt-customize ==="
              which virt-customize
              virt-customize --version

              echo ""
              echo "=== Check libguestfs backend ==="
              export LIBGUESTFS_DEBUG=1
              export LIBGUESTFS_TRACE=1

              echo ""
              echo "=== Copy cloud image ==="
              cp /mnt/fcvm-btrfs/cache/ubuntu-24.04-amd64.img /tmp/test-image.img
              ls -la /tmp/test-image.img

              echo ""
              echo "=== Run virt-customize (with 120s timeout) ==="
              echo "Start: $(date)"
              timeout 120 virt-customize \
                --add /tmp/test-image.img \
                --run-command "echo Hello from virt-customize" \
                2>&1 || {
                  echo ""
                  echo "=== FAILED or TIMED OUT ==="
                  echo "Exit code: $?"
                  echo "End: $(date)"

                  echo ""
                  echo "=== Check running processes ==="
                  ps aux | grep -E "(qemu|kvm|guestfs)" || true

                  echo ""
                  echo "=== dmesg last 30 lines ==="
                  dmesg 2>/dev/null | tail -30 || true

                  exit 1
                }

              echo ""
              echo "=== SUCCESS ==="
              echo "End: $(date)"
            '

      - name: If failed - check host state
        if: failure()
        run: |
          echo "=== Host processes ==="
          ps aux | grep -E "(qemu|kvm|podman)" | head -20
          echo ""
          echo "=== Host dmesg ==="
          sudo dmesg | tail -50
