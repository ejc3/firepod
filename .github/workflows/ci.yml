name: CI

on:
  pull_request:
    branches: [main]
  push:
    branches: [main]

env:
  CARGO_TERM_COLOR: always

jobs:
  # Fast jobs run in parallel on every PR and push

  lint:
    name: Lint
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          path: fcvm
      - uses: actions/checkout@v4
        with:
          repository: ejc3/fuse-backend-rs
          ref: master
          path: fuse-backend-rs
      - uses: actions/checkout@v4
        with:
          repository: ejc3/fuser
          ref: master
          path: fuser
      - uses: dtolnay/rust-toolchain@stable
        with:
          components: clippy, rustfmt
      - name: Check formatting
        working-directory: fcvm
        run: cargo fmt --all -- --check
      - name: Clippy
        working-directory: fcvm
        run: cargo clippy --all-targets --all-features -- -D warnings

  build:
    name: Build
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          path: fcvm
      - uses: actions/checkout@v4
        with:
          repository: ejc3/fuse-backend-rs
          ref: master
          path: fuse-backend-rs
      - uses: actions/checkout@v4
        with:
          repository: ejc3/fuser
          ref: master
          path: fuser
      - uses: dtolnay/rust-toolchain@stable
      - uses: Swatinem/rust-cache@v2
        with:
          workspaces: fcvm
      - name: Build
        working-directory: fcvm
        run: cargo build --release --all-targets

  test-unit:
    name: Unit Tests
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          path: fcvm
      - uses: actions/checkout@v4
        with:
          repository: ejc3/fuse-backend-rs
          ref: master
          path: fuse-backend-rs
      - uses: actions/checkout@v4
        with:
          repository: ejc3/fuser
          ref: master
          path: fuser
      - uses: dtolnay/rust-toolchain@stable
      - uses: Swatinem/rust-cache@v2
        with:
          workspaces: fcvm
      - name: Run unit tests
        working-directory: fcvm
        run: cargo test --release --lib --all

  test-fuse-integration:
    name: FUSE Integration
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          path: fcvm
      - uses: actions/checkout@v4
        with:
          repository: ejc3/fuse-backend-rs
          ref: master
          path: fuse-backend-rs
      - uses: actions/checkout@v4
        with:
          repository: ejc3/fuser
          ref: master
          path: fuser
      - uses: dtolnay/rust-toolchain@stable
      - uses: Swatinem/rust-cache@v2
        with:
          workspaces: fcvm
      - name: Build
        working-directory: fcvm
        run: cargo build --release -p fuse-pipe
      - name: Run integration_root tests
        working-directory: fcvm
        run: sudo -E env "PATH=$PATH" cargo test --release -p fuse-pipe --test integration_root -- --test-threads=1

  test-cli:
    name: CLI Tests
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          path: fcvm
      - uses: actions/checkout@v4
        with:
          repository: ejc3/fuse-backend-rs
          ref: master
          path: fuse-backend-rs
      - uses: actions/checkout@v4
        with:
          repository: ejc3/fuser
          ref: master
          path: fuser
      - uses: dtolnay/rust-toolchain@stable
      - uses: Swatinem/rust-cache@v2
        with:
          workspaces: fcvm
      - name: Run CLI tests
        working-directory: fcvm
        run: cargo test --release --test test_cli_parsing --test test_state_manager

  test-fuse-permissions:
    name: FUSE Permissions
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          path: fcvm
      - uses: actions/checkout@v4
        with:
          repository: ejc3/fuse-backend-rs
          ref: master
          path: fuse-backend-rs
      - uses: actions/checkout@v4
        with:
          repository: ejc3/fuser
          ref: master
          path: fuser
      - name: Run permission tests (container)
        working-directory: fcvm
        run: |
          export FUSE_BACKEND_RS=${{ github.workspace }}/fuse-backend-rs
          export FUSER=${{ github.workspace }}/fuser
          export CONTAINER_ARCH=x86_64
          make container-test-root

  test-pjdfstest:
    name: POSIX Compliance
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          path: fcvm
      - uses: actions/checkout@v4
        with:
          repository: ejc3/fuse-backend-rs
          ref: master
          path: fuse-backend-rs
      - uses: actions/checkout@v4
        with:
          repository: ejc3/fuser
          ref: master
          path: fuser
      - name: Run pjdfstest (container)
        working-directory: fcvm
        run: |
          export FUSE_BACKEND_RS=${{ github.workspace }}/fuse-backend-rs
          export FUSER=${{ github.workspace }}/fuser
          export CONTAINER_ARCH=x86_64
          make container-test-pjdfstest

  test-vm-sanity:
    name: VM Sanity
    runs-on: buildjet-32vcpu-ubuntu-2204
    steps:
      - uses: actions/checkout@v4
        with:
          path: fcvm
      - uses: actions/checkout@v4
        with:
          repository: ejc3/fuse-backend-rs
          ref: master
          path: fuse-backend-rs
      - uses: actions/checkout@v4
        with:
          repository: ejc3/fuser
          ref: master
          path: fuser
      - name: Check KVM availability
        run: |
          echo "=== KVM device ==="
          ls -la /dev/kvm || echo "No /dev/kvm"
          echo "=== CPU virtualization ==="
          grep -E "(vmx|svm)" /proc/cpuinfo | head -1 || echo "No VMX/SVM"
          echo "=== KVM modules ==="
          lsmod | grep kvm || echo "No KVM modules"
      - name: Setup KVM permissions
        run: sudo chmod 666 /dev/kvm
      - name: Setup NBD module for rootfs extraction
        run: |
          sudo modprobe nbd max_part=8
          ls -la /dev/nbd* | head -5
      - name: Setup network namespace directory
        run: sudo mkdir -p /var/run/netns
      - name: Setup dnsmasq for VM DNS
        run: |
          sudo apt-get update
          sudo apt-get install -y dnsmasq
          sudo tee /etc/dnsmasq.d/fcvm.conf > /dev/null <<EOF
          bind-dynamic
          server=8.8.8.8
          server=8.8.4.4
          no-resolv
          cache-size=1000
          EOF
          sudo systemctl restart dnsmasq
          sudo systemctl status dnsmasq
      - name: Clear cached rootfs (force rebuild with symlink fix)
        run: |
          sudo rm -f /mnt/fcvm-btrfs/rootfs/base.ext4
          sudo rm -f /mnt/fcvm-btrfs/cache/*.img
      - name: Debug network setup
        run: |
          echo "=== Host network interfaces ==="
          ip addr show
          echo ""
          echo "=== Default route ==="
          ip route show default
          echo ""
          echo "=== IP forwarding status ==="
          cat /proc/sys/net/ipv4/ip_forward
          echo ""
          echo "=== iptables NAT table ==="
          sudo iptables -t nat -L -n -v
          echo ""
          echo "=== dnsmasq status ==="
          sudo systemctl status dnsmasq || true
          echo ""
          echo "=== dnsmasq listening ports ==="
          sudo ss -ulnp | grep dnsmasq || echo "no dnsmasq listening"
          echo ""
          echo "=== Test DNS resolution from host ==="
          nslookup public.ecr.aws 8.8.8.8 || echo "DNS lookup failed"
      - name: Run VM sanity test (bridged)
        working-directory: fcvm
        run: |
          export FUSE_BACKEND_RS=${{ github.workspace }}/fuse-backend-rs
          export FUSER=${{ github.workspace }}/fuser
          export CONTAINER_ARCH=x86_64
          make container-test-vm-bridged
