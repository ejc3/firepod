name: CI

on:
  workflow_dispatch:
    inputs:
      job:
        description: 'Which job to run'
        type: choice
        default: 'both'
        options:
          - both
          - host
          - container
  pull_request:
    branches: [main]
  push:
    branches: [main]

# Cancel in-progress runs when a new revision is pushed
concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

env:
  CARGO_TERM_COLOR: always
  FUSE_BACKEND_RS: ${{ github.workspace }}/fuse-backend-rs
  FUSER: ${{ github.workspace }}/fuser
  CONTAINER_ARCH: x86_64

jobs:
  # Runner 0: Lint (default GitHub runner, no KVM needed)
  # Fast checks: fmt, clippy, audit, deny
  lint:
    name: Lint
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v6
        with:
          path: fcvm
      - uses: actions/checkout@v6
        with:
          repository: ejc3/fuse-backend-rs
          ref: master
          path: fuse-backend-rs
      - uses: actions/checkout@v6
        with:
          repository: ejc3/fuser
          ref: master
          path: fuser
      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          components: rustfmt, clippy
      - name: Get dependency SHAs
        id: deps
        run: |
          echo "fuser=$(git -C fuser rev-parse HEAD)" >> $GITHUB_OUTPUT
          echo "fuse-backend-rs=$(git -C fuse-backend-rs rev-parse HEAD)" >> $GITHUB_OUTPUT
      - uses: Swatinem/rust-cache@v2
        with:
          workspaces: fcvm -> target
          shared-key: deps-${{ steps.deps.outputs.fuser }}-${{ steps.deps.outputs.fuse-backend-rs }}
      - name: Install build dependencies
        run: sudo apt-get update && sudo apt-get install -y libfuse3-dev libclang-dev clang
      - name: Install cargo tools
        run: cargo install cargo-audit cargo-deny --locked
      - name: Check formatting
        working-directory: fcvm
        run: cargo fmt -p fcvm -p fuse-pipe -p fc-agent --check
      - name: Clippy
        working-directory: fcvm
        run: cargo clippy --all-targets -- -D warnings
      - name: Audit
        working-directory: fcvm
        run: cargo audit
      - name: Deny
        working-directory: fcvm
        run: cargo deny check

  # Runner 0b: Packaging (default GitHub runner, no KVM needed)
  # Verifies cargo install works without source tree access
  packaging:
    name: Packaging
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v6
        with:
          path: fcvm
      - uses: actions/checkout@v6
        with:
          repository: ejc3/fuse-backend-rs
          ref: master
          path: fuse-backend-rs
      - uses: actions/checkout@v6
        with:
          repository: ejc3/fuser
          ref: master
          path: fuser
      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable
      - name: Get dependency SHAs
        id: deps
        run: |
          echo "fuser=$(git -C fuser rev-parse HEAD)" >> $GITHUB_OUTPUT
          echo "fuse-backend-rs=$(git -C fuse-backend-rs rev-parse HEAD)" >> $GITHUB_OUTPUT
      - uses: Swatinem/rust-cache@v2
        with:
          workspaces: fcvm -> target
          shared-key: deps-${{ steps.deps.outputs.fuser }}-${{ steps.deps.outputs.fuse-backend-rs }}
      - name: Install build dependencies
        run: sudo apt-get update && sudo apt-get install -y libfuse3-dev libclang-dev clang
      - name: Build release
        working-directory: fcvm
        run: cargo build --release -p fcvm
      - name: Test packaging
        working-directory: fcvm
        run: ./scripts/test-packaging.sh ./target/release/fcvm

  # Runner 1: Host (bare metal with KVM)
  # Runs: test-unit → test-fast → test-root (sequential)
  # DISABLED: x86_64 runners lack nested virt, tests designed for ARM64
  host:
    name: Host
    if: false
    runs-on: buildjet-32vcpu-ubuntu-2204
    steps:
      - uses: actions/checkout@v6
        with:
          path: fcvm
      - uses: actions/checkout@v6
        with:
          repository: ejc3/fuse-backend-rs
          ref: master
          path: fuse-backend-rs
      - uses: actions/checkout@v6
        with:
          repository: ejc3/fuser
          ref: master
          path: fuser
      - name: Install Rust
        run: |
          curl --proto '=https' --tlsv1.2 -sSf https://sh.rustup.rs | sh -s -- -y
          echo "$HOME/.cargo/bin" >> $GITHUB_PATH
      - name: Get dependency SHAs
        id: deps
        run: |
          echo "fuser=$(git -C fuser rev-parse HEAD)" >> $GITHUB_OUTPUT
          echo "fuse-backend-rs=$(git -C fuse-backend-rs rev-parse HEAD)" >> $GITHUB_OUTPUT
      - uses: Swatinem/rust-cache@v2
        with:
          cache-provider: buildjet
          workspaces: fcvm -> target
          cache-on-failure: "true"
          shared-key: deps-${{ steps.deps.outputs.fuser }}-${{ steps.deps.outputs.fuse-backend-rs }}
      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y fuse3 libfuse3-dev libclang-dev clang musl-tools \
            iproute2 iptables slirp4netns dnsmasq qemu-utils e2fsprogs parted \
            podman skopeo busybox-static cpio zstd autoconf automake libtool
      - name: Install Firecracker
        run: |
          curl -L -o /tmp/firecracker.tgz \
            https://github.com/firecracker-microvm/firecracker/releases/download/v1.14.0/firecracker-v1.14.0-x86_64.tgz
          sudo tar -xzf /tmp/firecracker.tgz -C /usr/local/bin --strip-components=1 \
            release-v1.14.0-x86_64/firecracker-v1.14.0-x86_64 \
            release-v1.14.0-x86_64/jailer-v1.14.0-x86_64
          sudo mv /usr/local/bin/firecracker-v1.14.0-x86_64 /usr/local/bin/firecracker
          sudo mv /usr/local/bin/jailer-v1.14.0-x86_64 /usr/local/bin/jailer
      - name: Install cargo tools
        # cargo-audit >= 0.22.0 required for CVSS 4.0 support
        # Use --force to override any stale cached versions
        # Create symlinks in /usr/local/bin so sudo can find cargo tools
        run: |
          cargo install cargo-nextest@0.9.115 cargo-audit@0.22.0 cargo-deny@0.18.9 --locked --force
          sudo ln -sf $HOME/.cargo/bin/cargo /usr/local/bin/
          sudo ln -sf $HOME/.cargo/bin/cargo-audit /usr/local/bin/
          sudo ln -sf $HOME/.cargo/bin/cargo-deny /usr/local/bin/
          sudo ln -sf $HOME/.cargo/bin/cargo-fmt /usr/local/bin/
          sudo ln -sf $HOME/.cargo/bin/cargo-clippy /usr/local/bin/
      - name: Setup KVM and networking
        run: |
          sudo chmod 666 /dev/kvm
          sudo mkdir -p /var/run/netns
          sudo iptables -P FORWARD ACCEPT
          sudo iptables -t nat -A POSTROUTING -s 172.30.0.0/16 -o eth0 -j MASQUERADE || true
          if [ ! -e /dev/userfaultfd ]; then
            sudo mknod /dev/userfaultfd c 10 126
          fi
          sudo chmod 666 /dev/userfaultfd
          sudo sysctl -w vm.unprivileged_userfaultfd=1
          # Enable FUSE allow_other for tests
          echo "user_allow_other" | sudo tee /etc/fuse.conf
      - name: Create test log directory
        run: mkdir -p /tmp/fcvm-test-logs
      - name: test-unit
        working-directory: fcvm
        run: make test-unit
      - name: setup-fcvm
        working-directory: fcvm
        run: make setup-fcvm
      - name: test-fast
        working-directory: fcvm
        run: make test-fast
      - name: test-root
        working-directory: fcvm
        run: make test-root
      - name: Capture kernel logs
        if: always()
        run: |
          # Filter dmesg for UFFD/memory/VM related messages only
          sudo dmesg | grep -iE 'userfault|uffd|kvm|firecracker|oom|killed|segfault|page.fault' > /tmp/fcvm-test-logs/dmesg-filtered.log || true
      - name: Upload test logs
        if: always()
        uses: actions/upload-artifact@v6
        with:
          name: test-logs-host
          path: /tmp/fcvm-test-logs/
          if-no-files-found: ignore
          retention-days: 14

  # Runner 2: Container (podman)
  # Runs same tests as Host but inside a container
  # Needs KVM for VM tests (container mounts /dev/kvm)
  container:
    name: Container
    if: ${{ github.event.inputs.job != 'host' }}
    runs-on: buildjet-32vcpu-ubuntu-2204
    steps:
      - uses: actions/checkout@v6
        with:
          path: fcvm
      - uses: actions/checkout@v6
        with:
          repository: ejc3/fuse-backend-rs
          ref: master
          path: fuse-backend-rs
      - uses: actions/checkout@v6
        with:
          repository: ejc3/fuser
          ref: master
          path: fuser
      - name: Setup KVM and rootless podman
        run: |
          sudo chmod 666 /dev/kvm
          # Enable userfaultfd syscall for snapshot cloning
          sudo sysctl -w vm.unprivileged_userfaultfd=1
          # Configure rootless podman to use cgroupfs (no systemd session on CI)
          mkdir -p ~/.config/containers
          printf '[engine]\ncgroup_manager = "cgroupfs"\nevents_logger = "file"\n' > ~/.config/containers/containers.conf
          # Create cargo cache directory for container
          mkdir -p ${{ github.workspace }}/cargo-cache/registry ${{ github.workspace }}/cargo-cache/target
      - name: Cache container cargo
        uses: actions/cache@v5
        with:
          path: ${{ github.workspace }}/cargo-cache
          key: container-cargo-${{ hashFiles('fcvm/Cargo.lock') }}
          restore-keys: container-cargo-
      - name: Create test log directory
        run: mkdir -p /tmp/fcvm-test-logs
      - name: container-test-unit
        env:
          CARGO_CACHE_DIR: ${{ github.workspace }}/cargo-cache
        working-directory: fcvm
        run: make container-test-unit
      - name: container-setup-fcvm
        env:
          CARGO_CACHE_DIR: ${{ github.workspace }}/cargo-cache
        working-directory: fcvm
        run: make container-setup-fcvm
      - name: container-test
        env:
          CARGO_CACHE_DIR: ${{ github.workspace }}/cargo-cache
        working-directory: fcvm
        run: make container-test
      - name: Capture kernel logs
        if: always()
        run: |
          # Filter dmesg for UFFD/memory/VM related messages only
          sudo dmesg | grep -iE 'userfault|uffd|kvm|firecracker|oom|killed|segfault|page.fault' > /tmp/fcvm-test-logs/dmesg-filtered.log || true
      - name: Upload test logs
        if: always()
        uses: actions/upload-artifact@v6
        with:
          name: test-logs-container
          path: /tmp/fcvm-test-logs/
          if-no-files-found: ignore
          retention-days: 14
