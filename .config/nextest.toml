# cargo-nextest configuration
# https://nexte.st/book/configuration.html

[store]
# Store test results for analysis
dir = "target/nextest"

# Default profile
[profile.default]
# Run tests in parallel by default
test-threads = "num-cpus"
# Timeout per test (VM tests can be slow)
slow-timeout = { period = "60s", terminate-after = 2 }
# Fail fast on first failure
fail-fast = false
# Retry flaky tests once
retries = 0
# Status level for output
status-level = "pass"
final-status-level = "flaky"
# Show output immediately (don't capture)
success-output = "immediate"
failure-output = "immediate"

# CI profile - more verbose, stricter
[profile.ci]
test-threads = "num-cpus"
slow-timeout = { period = "120s", terminate-after = 2 }
fail-fast = false
retries = 0
status-level = "all"
final-status-level = "all"

# Quick profile for development
[profile.quick]
test-threads = "num-cpus"
slow-timeout = { period = "30s", terminate-after = 1 }
fail-fast = true
retries = 0

# Stress tests need exclusive access (100 VMs at once)
[test-groups.stress-tests]
max-threads = 1

# Snapshot tests limited to 3 concurrent (each snapshot is ~5.6GB on disk)
[test-groups.snapshot-tests]
max-threads = 3

# VM tests run at full parallelism (num-cpus)
[test-groups.vm-tests]
max-threads = "num-cpus"

[[profile.default.overrides]]
filter = "package(fcvm) & test(/stress_100/)"
test-group = "stress-tests"
slow-timeout = { period = "600s", terminate-after = 1 }

# Snapshot tests: limited to 3 concurrent (each creates ~5.6GB snapshot on disk)
[[profile.default.overrides]]
filter = "package(fcvm) & (test(/snapshot/) | test(/clone/))"
test-group = "snapshot-tests"
slow-timeout = { period = "600s", terminate-after = 1 }

# VM tests get 10 minute timeout (non-snapshot tests)
[[profile.default.overrides]]
filter = "package(fcvm) & test(/test_/) & !test(/stress_100/) & !test(/pjdfstest_vm/) & !test(/snapshot/) & !test(/clone/)"
test-group = "vm-tests"
slow-timeout = { period = "600s", terminate-after = 1 }

# In-VM pjdfstest needs 15 minutes (image import via FUSE over vsock is slow)
[[profile.default.overrides]]
filter = "package(fcvm) & test(/pjdfstest_vm/)"
test-group = "vm-tests"
slow-timeout = { period = "900s", terminate-after = 1 }

# fuse-pipe tests can run with full parallelism
[[profile.default.overrides]]
filter = "package(fuse-pipe)"
test-group = "@global"
slow-timeout = { period = "120s", terminate-after = 1 }
