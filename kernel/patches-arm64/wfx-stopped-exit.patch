From: fcvm <fcvm@localhost>
Subject: [PATCH] KVM: arm64: Exit to userspace on WFI when vCPU is stopped

After PSCI SYSTEM_OFF, the guest may enter a WFI loop waiting for
power-off. Currently kvm_handle_wfx() always returns 1 (continue
running), causing the vCPU to spin at 100% CPU doing WFI → exit →
re-enter → WFI.

Check if the vCPU has been marked as stopped (mp_state == STOPPED)
and return 0 to exit to userspace, allowing the VMM to handle the
shutdown properly.

This fixes VMs hanging on `halt -f` while `reboot -f` works correctly.
Enables graceful shutdown via PSCI SYSTEM_OFF.

Signed-off-by: fcvm <fcvm@localhost>
---
 arch/arm64/kvm/handle_exit.c | 12 ++++++++++++
 1 file changed, 12 insertions(+)

--- a/arch/arm64/kvm/handle_exit.c
+++ b/arch/arm64/kvm/handle_exit.c
@@ -130,6 +130,18 @@ static int kvm_handle_wfx(struct kvm_vcpu *vcpu)
 {
 	u64 esr = kvm_vcpu_get_esr(vcpu);
 	bool is_wfe = !!(esr & ESR_ELx_WFx_ISS_WFE);
+
+	/*
+	 * If the vCPU has been marked as stopped (e.g., after PSCI SYSTEM_OFF),
+	 * exit to userspace instead of continuing to run. This prevents the
+	 * vCPU from spinning in a WFI loop at 100% CPU when the guest is
+	 * trying to power off.
+	 */
+	if (kvm_arm_vcpu_stopped(vcpu)) {
+		vcpu->run->exit_reason = KVM_EXIT_SYSTEM_EVENT;
+		vcpu->run->system_event.type = KVM_SYSTEM_EVENT_SHUTDOWN;
+		return 0;
+	}

 	if (guest_hyp_wfx_traps_enabled(vcpu))
 		return kvm_inject_nested_sync(vcpu, kvm_vcpu_get_esr(vcpu));
